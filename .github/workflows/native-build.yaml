##name: Build Quarkus Native Multi-Arch
##
##on:
##  push:
##    branches: ["main"]
##  workflow_dispatch:
##
##permissions:
##  contents: read
##  packages: write
##
##jobs:
##  build-native:
##    runs-on: ubuntu-latest
##
##    steps:
##      - name: Checkout source
##        uses: actions/checkout@v4
##
##      - name: Set up JDK 21
##        uses: actions/setup-java@v4
##        with:
##          distribution: temurin
##          java-version: 21
##
##      - name: Setup QEMU (support ARM64 build)
##        uses: docker/setup-qemu-action@v3
##
##      - name: Set up Docker Buildx
##        uses: docker/setup-buildx-action@v3
##
##      - name: Login to GHCR
##        uses: docker/login-action@v3
##        with:
##          registry: ghcr.io
##          username: ${{ github.actor }}
##          password: ${{ secrets.GITHUB_TOKEN }}
##
###      - name: Build Quarkus Native Binary
###        run: |
###          chmod +x mvnw
###          ./mvnw clean package -Pnative -Dquarkus.native.container-build=true
###        env:
###          GITHUB_TOKEN: ${{ secrets.TOKEN_MVN }}
##      - name: Build and Push Multi-Arch Image
##        uses: docker/build-push-action@v6
##        with:
##          context: .
##          file: src/main/docker/Dockerfile.native
##          platforms: linux/amd64,linux/arm64
##          push: true
##          tags: |
##            ghcr.io/${{ github.repository }}:latest
##            ghcr.io/${{ github.repository }}:${{ github.sha }}
#
#name: Build Native Quarkus
#
#on:
#  push:
#    branches: [ "main" ]
#
#jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#
#      - name: Login GHCR
#        uses: docker/login-action@v3
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Build Native Image with Maven Secrets
#        run: |
#          export DOCKER_BUILDKIT=1
#
#          docker build \
#            -f src/main/docker/Dockerfile
#            --secret id=maven-pass,env=MAVEN_PASSWORD \
#            --secret id=maven-user,env=MAVEN_USERNAME \
#            -t ghcr.io/${{ github.repository }}latest \
#            .
#
#        env:
#          MAVEN_USERNAME: github
#          MAVEN_PASSWORD: ${{ secrets.TOKEN_MVN }}
#
#      - name: Push Image
#        run: docker push ghcr.io/${{ github.repository }}:latest
#

name: Build Native ARM64 Quarkus

on:
  push:
    branches: [ "main" ]

jobs:
  build-native-arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable QEMU (ARM emulation)
        uses: docker/setup-qemu-action@v3

      - name: Enable buildx (multi-arch)
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ARM64 Native image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -f src/main/docker/Dockerfile \
            --secret id=maven-user,env=MAVEN_USERNAME \
            --secret id=maven-pass,env=MAVEN_PASSWORD \
            -t ghcr.io/${{ github.repository }}:latest \
            --push \
            .

        env:
          MAVEN_USERNAME: github
          MAVEN_PASSWORD: ${{ secrets.TOKEN_MVN }}

